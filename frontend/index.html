<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My APM Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; background-color: #f0f2f5; display: flex; flex-wrap: wrap; justify-content: center; }
        .chart-container { width: 40%; margin: 20px; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stat-container { width: 40%; margin: 20px; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center;}
        h2 { margin-top: 0; }
        #appStatus { font-size: 4em; font-weight: bold; }
        #statusDescription { margin-top: 0; margin-bottom: 20px; min-height: 20px; }
        .status-ok { color: green; }
        .status-error { color: red; }
        .button-container button { font-size: 1em; padding: 10px 20px; margin: 0 10px; cursor: pointer; border: 1px solid #ccc; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="chart-container"><h2>CPU Usage</h2><canvas id="cpuChart"></canvas></div>
    <div class="chart-container"><h2>Memory Usage (%)</h2><canvas id="memChart"></canvas></div>

    <div class="stat-container">
        <h2>Live Application Health Check</h2>
        <div id="appStatus">--</div>
        <p id="statusDescription">Click a button to check a port's status.</p>
        <div class="button-container">
            <button onclick="checkStatus(3000)">Check Port 3000 (Will Fail)</button>
            <button onclick="checkStatus(5000)">Check Port 5000 (Will Succeed)</button>
        </div>
    </div>

    <script>
        // --- FUNCTION TO CREATE CHARTS ---
        async function renderChart(canvasId, apiUrl, label, color) {
            const response = await fetch(apiUrl);
            const data = await response.json();
            const labels = data.map(item => new Date(item.time).toLocaleTimeString());
            const values = data.map(item => item[Object.keys(item)[1]]);
            new Chart(document.getElementById(canvasId), {
                type: 'line',
                data: { labels: labels, datasets: [{ label: label, data: values, borderColor: color, tension: 0.1 }] },
                options: { scales: { y: { beginAtZero: true } } }
            });
        }

        // --- UPDATED FUNCTION TO CHECK STATUS AND ADD DESCRIPTION ---
        async function checkStatus(port) {
            const response = await fetch(`http://localhost:5000/api/check-port/${port}`);
            const data = await response.json();
            const statusEl = document.getElementById('appStatus');
            const descriptionEl = document.getElementById('statusDescription');

            statusEl.textContent = data.status;

            if (data.status === 200) {
                statusEl.className = 'status-ok';
                descriptionEl.textContent = "Success: The service is online and responding.";
            } else if (data.status === 503) {
                statusEl.className = 'status-error';
                descriptionEl.textContent = "Error: Service unavailable. The port is closed or not responding.";
            } else {
                statusEl.className = 'status-error';
                descriptionEl.textContent = `An unexpected error occurred: ${data.message}`;
            }
        }

        // --- LOAD CHARTS ON PAGE LOAD ---
        renderChart('cpuChart', 'http://localhost:5000/api/cpu-data', 'User CPU Usage (%)', 'rgb(75, 192, 192)');
        renderChart('memChart', 'http://localhost:5000/api/mem-data', 'Memory Used (%)', 'rgb(255, 99, 132)');
    </script>
</body>
</html>